<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조합정보조회</title>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/datatables-custom.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/slimTable.css}">
    <script th:src="@{/js/common.js}"></script>
    <script defer th:src="@{/js/searchModal.js}"></script>

    <style></style>
    <script>
        let fundId = /*[[${fundId}]]*/ '';
        // console.log("fundId:", fundId);
        document.addEventListener("DOMContentLoaded", function () {
            let fundId = /*[[${fundId}]]*/ '';
            // console.log("fundId:", fundId);
            if (fundId) {
                console.log("fundId: " + fundId);
                fetchFundInfo(fundId);
            }
        });

        function fetchFundInfo(fundId) {
            // fetch(`/api/companies/FundRead/${fundId}`)
            fetch(`/api/companies/info/${fundId}`)
                .then(response => response.json())
                .then(data => updateFundInfo(data))
                .catch(error => console.error("데이터 로드 실패:", error));
        }

        function updateFundInfo(data) {
            document.getElementById("fundId").value = data.fundId || "";
            document.getElementById("FundName").value = data.FundName || "";
            document.getElementById("establishmentDate").value = data.establishmentDate || "";
            document.getElementById("ceoName").value = data.ceoName || "";
            document.getElementById("FundAddress").value = data.FundAddress || "";
            document.getElementById("businessRegistrationNumber").value = data.businessRegistrationNumber || "";
            document.getElementById("corporateRegistrationNumber").value = data.corporateRegistrationNumber || "";
            document.getElementById("industryCode").value = data.industryCode || "";
            document.getElementById("capital").value = data.capital || "";
            document.getElementById("parValue").value = data.parValue || "";
            document.getElementById("employeeCount").value = data.employeeCount || "";

            document.getElementById("kuhSubsidiary").value = data.kuhSubsidiary || "";
            document.getElementById("kuhStartup").value = data.kuhStartup || "";
            document.getElementById("startupType").value = data.startupType || "";
            document.getElementById("earlyStartupType").value = data.earlyStartupType || "";
            document.getElementById("smeStatus").value = data.smeStatus || "";
            document.getElementById("regionalFund").value = data.regionalFund || "";
            document.getElementById("ventureRecognition").value = data.ventureRecognition || "";
            document.getElementById("researchRecognition").value = data.researchRecognition || "";
            document.getElementById("publicTechnologyTransfer").value = data.publicTechnologyTransfer || "";
            document.getElementById("dueDiligence").value = data.dueDiligence || "";
            document.getElementById("listingStatus").value = data.listingStatus || "";

            document.getElementById("investmentSector").value = data.investmentSector || "";
            document.getElementById("mainProducts").value = data.mainProducts || "";
            document.getElementById("investmentPoint1").value = data.investmentPoint1 || "";
            document.getElementById("investmentPoint2").value = data.investmentPoint2 || "";
            document.getElementById("investmentPoint3").value = data.investmentPoint3 || "";

            document.getElementById("manager1").value = data.manager1 || "";
            document.getElementById("manager2").value = data.manager2 || "";
            document.getElementById("manager3").value = data.manager3 || "";
            document.getElementById("positionType").value = data.positionType || "";
            document.getElementById("phoneNumber").value = data.phoneNumber || "";
            document.getElementById("email").value = data.email || "";
            document.getElementById("name").value = data.name || "";

            if (data.currentStatusDTO) {
                document.getElementById("status").value = data.currentStatusDTO.status || "";
            }

            if (data.rmngDTO) {
                document.getElementById("managementYear").value = data.rmngDTO.manageYear || "";
                document.getElementById("evalGrade").value = data.rmngDTO.evalGrade || "";
                document.getElementById("businessProgress1").value = data.rmngDTO.businessProgress1 || "";
                document.getElementById("businessProgress2").value = data.rmngDTO.businessProgress2 || "";
            }

            if (data.currentFundValue) {
                document.getElementById("currentFundValue").value = data.currentFundValue || "";
            }

            updateFinancialsTable(data.recentFinancials);
            updateInvestmentTable(data.rivtDTO);
            updateShareholderTable(data.shrDTO);
        }

        //재무제표
        function updateFinancialsTable(financials) {
            const tableBody = document.getElementById("financialsTable");
            tableBody.innerHTML = "";

            financials.forEach(financial => {
                const row = `<tr>
            <td>${financial.financialYear || ""} (${financial.financialHalf === 1 ? "상반기" : "하반기"})</td>
            <td>${financial.revenue?.toLocaleString() || ""}</td>
            <td>${financial.operatingProfit?.toLocaleString() || ""}</td>
            <td>${financial.netIncome?.toLocaleString() || ""}</td>
            <td>${financial.totalAssets?.toLocaleString() || ""}</td>
            <td>${financial.totalDebt?.toLocaleString() || ""}</td>
            <td>${financial.totalCapital?.toLocaleString() || ""}</td>
            <td>${financial.capital?.toLocaleString() || ""}</td>
            <td>${financial.employeeCount?.toLocaleString() || ""}</td>
        </tr>`;
                tableBody.innerHTML += row;
            });
        }
        //투자정보
        function updateInvestmentTable(investmentData) {
            const tableBody = document.getElementById("investmentTable");
            tableBody.innerHTML = "";

            const row = `<tr>
            <td>${investmentData.investmentDate || ""}</td>
            <td>${investmentData.investmentProduct || ""}</td>
            <td>${investmentData.investmentSumPrice?.toLocaleString() || ""} 원</td>
            <td>${investmentData.investmentUnitPrice?.toLocaleString() || ""} 원</td>
            <td>${investmentData.shareCount?.toLocaleString() || ""} 주</td>
            <td>${investmentData.equityRate?.toFixed(2) || ""} %</td>
            <td>${investmentData.totalShares?.toLocaleString() || ""} 주</td>
            <td>${investmentData.investmentValue?.toLocaleString() || ""} 억원</td>
            <td>${investmentData.investmentStep || ""}</td>
        </tr>`;

            tableBody.innerHTML = row;
        }

        //주주명부
        function updateShareholderTable(shareholderData) {
            const tableBody = document.getElementById("shareholderTable");
            tableBody.innerHTML = "";

            // 주주명 데이터
            const nameRow = `<tr>
            <td>${shareholderData.shareholderName1 || ""}</td>
            <td>${shareholderData.shareholderName2 || ""}</td>
            <td>${shareholderData.shareholderName3 || ""}</td>
            <td>${shareholderData.shareholderName4 || ""}</td>
            <td>${shareholderData.shareholderName5 || ""}</td>
            <td>${shareholderData.shareholderName6 || ""}</td>
            <td>${shareholderData.shareholderName7 || ""}</td>
            <td>${shareholderData.shareholderName8 || ""}</td>
            <td class="align-middle">-</td>
        </tr>`;

            // 주식수량 데이터
            const countRow = `<tr>
            <td>${shareholderData.shareholderCount1?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount2?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount3?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount4?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount5?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount6?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount7?.toLocaleString() || ""}</td>
            <td>${shareholderData.shareholderCount8?.toLocaleString() || ""}</td>
            <td>${shareholderData.totalShareCount?.toLocaleString() || ""}</td>
        </tr>`;

            // 지분율 데이터
            const rateRow = `<tr>
            <td>${shareholderData.shareholderRate1?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate2?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate3?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate4?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate5?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate6?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate7?.toFixed(2) || ""} %</td>
            <td>${shareholderData.shareholderRate8?.toFixed(2) || ""} %</td>
            <td>${shareholderData.totalEquityRate?.toFixed(2) || "100.00"} %</td>
        </tr>`;

            tableBody.innerHTML = nameRow + countRow + rateRow;
        }


    </script>


    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            // ✅ fundId 값을 hidden input에서 가져오기
            let fundIdInput = document.getElementById("fundIdValue");
            let fundId = fundIdInput ? fundIdInput.value : null;

            console.log("✅ fundId:", fundId);

            if (fundId) {
                window.fundId = fundId; // ✅ 전역 변수에 저장
                fetchFundInfo(fundId); // ✅ 회사 정보 불러오기
            } else {
                console.warn("⚠️ fundId를 가져올 수 없습니다.");
            }
            // 입력 팝업 열기 함수
            // 팝업 열기 함수
            window.openPopup = function (type) {
                if (!window.fundId) {
                    alert("먼저 조합 정보를 조회한 후 입력하세요.");
                    return;
                }
                let url = `/fundAdd/${type}/${window.fundId}`;
                window.open(url, "popupWindow", "width=700,height=500,scrollbars=yes");
            };
            // 🔥 조회 팝업 열기 함수
            window.openViewPopup = function (type) {
                if (!window.fundId) {
                    alert("먼저 기업 정보를 조회한 후 확인하세요.");
                    return;
                }
                let url = `/fundShow/${type}/${window.fundId}`;
                window.open(url, "popupWindow", "width=1500,height=600,scrollbars=yes");
            };
        });
    </script>

</head>
<body>

<div th:replace="fragments/navbar :: navbar"></div>
<div th:replace="fragments/searchModal :: searchModal"></div>


<div class="wrapper">

    <input type="hidden" id="fundIdValue" th:value="${fundId}" />

    <!-- 📌 좌측 사이드바 -->
    <nav class="sidebar">
        <a href="#" onclick="openPopup('audit')">🧑🏻‍💼 회계감사인 관리</a>
        <a href="#" onclick="openViewPopup('auditsByFund')">🧑🏻‍💼 회계감사인 이력조회</a>
        <a href="#" onclick="openPopup('staff')">💼 운용인력 관리</a>
        <a href="#" onclick="openViewPopup('staffsByFund')">💼 운용인력 이력조회</a>
        <a href="#" onclick="openPopup('fundFinancial')">🗂️ 재무제표 관리</a>
        <a href="#" onclick="openViewPopup('financialsByFund')">🗂️ 재무제표 이력조회</a>
<!--        <a href="#" onclick="openViewPopup('members')">👤 투자조합원 관리</a>-->
        <a href="#" onclick="openViewPopup('membersByFund')">👤 투자조합원 변경・조회</a>
        <a href="#" onclick="openViewPopup('IASByfund')">💰 투자자산총괄표 조회</a>
<!--        <a href="#" onclick="openViewPopup('#')">🪪 투자조합평가결과 조회</a>-->
        <a href="#" onclick="openViewPopup('dueDiligenceByFund')">🔍 투자기업실사 조회</a>
        <a href="#" onclick="openViewPopup('empChangeByFund')">👥 투자기업고용변경 조회</a>
    </nav>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let fundId = document.getElementById("fundIdValue").value;
            console.log("✅ fundId:", fundId);
            if (fundId) {
                fetchFundInfo(fundId);
            }
        });
    </script>
    <!-- 📌 메인 콘텐츠 영역 -->
    <div class="content">
        <h2>🏦 조합 정보 조회</h2>
        <!-- 1. 회사 기본 정보 -->
        <table class="table table-bordered text-center">
            <tbody>
            <tr><th colspan="7">투자조합 기본정보</th></tr>
            <tr>
                <th>조합 고유번호</th>
                <td colspan="2"><input type="text" class="form-control" name="fundId" id="fundId" required></td>
                <th>청산여부</th>
                <td>
                    <select class="form-control" name="liquidationStatus">
                        <option value="">선택하세요.</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </td>
                <th>청산일자</th>
                <td><input type="date" class="form-control" name="liquidationDate"></td>
            </tr>
            <tr>
                <th>세부조합명</th>
                <td colspan="2"><input type="text" class="form-control" name="fundNameDetail"></td>
                <th>조합명</th>
                <td><input type="text" class="form-control" name="fundName"></td>
                <th>설립일자</th>
                <td><input type="date" class="form-control" name="establishmentDate"></td>
            </tr>
            <tr>
                <th>존속기간(년)</th>
                <td colspan="2"><input type="number" class="form-control" name="duration"></td>
                <th>존속기간 시작일</th>
                <td><input type="date" class="form-control" name="durationStartDate" required></td>
                <th>존속기간 종료일</th>
                <td><input type="date" class="form-control" name="durationEndDate" required></td>
            </tr>
            <tr>
                <th>투자기간(년)</th>
                <td colspan="2"><input type="number" class="form-control" name="investmentDuration"></td>
                <th>투자기간 시작일</th>
                <td><input type="date" class="form-control" name="investmentStartDate"></td>
                <th>투자기간 종료일</th>
                <td><input type="date" class="form-control" name="investmentEndDate"></td>
            </tr>
            <tr>
                <th>약정 총액</th>
                <td colspan="2"><input type="number" class="form-control" name="committedTotalPrice"></td>
                <th>1좌당 금액</th>
                <td colspan="3"><input type="number" class="form-control" name="unitPrice"></td>
            </tr>
            <tr>
                <th>투자기구 유형</th>
                <td colspan="2">
                    <select class="form-control" name="fundOrganizationType">
                        <option value="">선택하세요.</option>
                        <option value="개인투자조합">개인투자조합</option>
                        <option value="벤처투자조합">벤처투자조합</option>
                    </select>
                </td>
                <th>납입방법</th>
                <td colspan="3">
                    <select class="form-control" name="paymentType">
                        <option value="">선택하세요.</option>
                        <option value="수시납">수시납</option>
                        <option value="일시납">일시납</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>운용인력 전원</th>
                <td colspan="6"><input type="text" class="form-control" name="currentStaff"></td>
            </tr>
            <tr>
                <th>회계감사인명</th>
                <td colspan="2"><input type="text" class="form-control" name="auditorName"></td>
                <th>회계감사인 변경일자</th>
                <td colspan="3"><input type="date" class="form-control" name="auditorDate"></td>
            </tr>
            <tr>
                <th>업무수탁법인</th>
                <td colspan="2"><input type="text" class="form-control" name="trusteeCorporation"></td>
                <th>사무수탁법인</th>
                <td colspan="3"><input type="text" class="form-control" name="administrationCorporation"></td>
            </tr>

            <tr><th colspan="7">투자조합 보수조건</th></tr>
            <tr>
                <th>기준수익률(%)</th>
                <td colspan="2"><input type="number" step="0.01" class="form-control" name="targetReturnRate"></td>
                <th>성과보수율(%)</th>
                <td colspan="3"><input type="number" step="0.01" class="form-control" name="performanceFeeRate" placeholder="없을 경우 0.0%"></td>
            </tr>
            <tr>
                <th>투자기간 관리보수 (%)</th>
                <td colspan="2"><input type="number" step="0.01" class="form-control" name="managementFeeInvestmentPeriod"></td>
                <th>약정기준 여부</th>
                <td colspan="3">
                    <select class="form-control" name="agreementCriteria">
                        <option value="">선택하세요.</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>운영기간 관리보수 (%)</th>
                <td colspan="2"><input type="number" step="0.01" class="form-control" name="managementFeeManagementPeriod"></td>
                <th>약정기준 여부</th>
                <td colspan="3">
                    <select class="form-control" name="agreementCriteria">
                        <option value="">선택하세요.</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>인센티브 조건</th>
                <td colspan="6"><input type="text" class="form-control" name="incentiveCondition"></td>
            </tr>
            <tr>
                <th>우선손실충당 GP</th>
                <td colspan="6"><input type="text" class="form-control" name="priorLossGP"></td>
            </tr>
            <tr>
                <th>우선손실충당 LP</th>
                <td colspan="6"><input type="text" class="form-control" name="priorLossLP"></td>
            </tr>
            </tbody>
        </table>

<!--        private String mandatoryInvestment1; // 의무투자-->
<!--        private String mandatoryInvestment2;-->
<!--        private String primaryInvestment1; // 주목적투자-->
<!--        private String primaryInvestment2; // 주목적투자-->
<!--        private String specialPurposeInvestment1; // 특수목적투자-->
<!--        private String specialPurposeInvestment2; // 특수목적투자-->
<!--        private String specialPurposeInvestment3; // 특수목적투자-->
<!--        private String specialPurposeInvestment4; // 특수목적투자기타-->


<!--        private List<RFundMemDTO> fundMems; //조합원 명부들-->


    </div>
</div>


<!-- 🔍 검색 모달 -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body p-2 d-flex align-items-center">
                <input type="text" id="fundIdInput" class="form-control me-2" placeholder="고유번호 입력" style="flex: 1; min-width: 120px;">
                <button type="button" class="btn btn-primary btn-sm" id="searchButton">검색</button>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
