<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>조합원 구성</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/slimTable.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/popUpNavbar.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

</head>
<body class="container mt-4">
<div th:replace="fragments/popUpNavbar :: navbar"></div>

<h2 class="mb-4">조합원 구성</h2>

<!-- 조합 ID 정보 -->
<!--<p style="display: none;"><strong>조합 ID:</strong> <span th:text="${fundId}"></span></p>-->

<!-- ✅ 조합원 테이블 -->
<table class="table table-bordered text-center">
    <thead>
    <tr>
        <th rowspan="2">조합원명</th>
        <th colspan="2">출자약정액</th>
        <th colspan="4">배분액</th>
        <th rowspan="2">출자잔액</th>
        <th rowspan="2">조합원유형</th>
        <th rowspan="2">배분순위</th>
    </tr>
    <tr>
        <th>금액</th>
        <th>비율</th>
        <th>원금</th>
        <th>이익</th>
        <th>총액</th>
        <th>비율</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="member : ${rMemtypeDTOS}">
        <td th:text="${member.memberName}"></td>
        <td class="text-end" th:text="${member.committedUnitPrice != null and member.committedUnitPrice != 0 ? #numbers.formatInteger(member.committedUnitPrice, 3, 'COMMA') : ''}"></td>
        <td class="text-end" th:text="${member.contributionRate != null and member.contributionRate != 0 ? #numbers.formatDecimal(member.contributionRate, 1, 2, 'POINT') : ''}"></td>

        <!-- 배분 원금 * 출자비율 -->
        <td class="text-end" th:text="${fund.allocPrincipal != null and fund.allocPrincipal != 0 ? #numbers.formatInteger(((fund.allocPrincipal ?: 0) * (member.contributionRate ?: 0) / 100), 3, 'COMMA') : ''}"></td>

        <!-- 배분 이익 * 출자비율 -->
        <td class="text-end" th:text="${fund.allocProfit != null and fund.allocProfit != 0 ? #numbers.formatInteger(((fund.allocProfit ?: 0) * (member.contributionRate ?: 0) / 100), 3, 'COMMA') : ''}"></td>

        <!-- 배분 총액 * 출자비율 -->
        <td class="text-end" th:text="${fund.allocTotal != null and fund.allocTotal != 0 ? #numbers.formatInteger(((fund.allocTotal ?: 0) * (member.contributionRate ?: 0) / 100), 3, 'COMMA') : ''}"></td>

        <td>-</td>
        <td>-</td>
        <td th:text="${member.memberType}"></td>
        <td>-</td>
    </tr>
    </tbody>
    <tfoot>
    <tr>
        <th>합계</th>
        <td class="text-end" th:text="${fund.getCommittedTotalPrice() != null and fund.getCommittedTotalPrice() != 0 ? #numbers.formatInteger(fund.getCommittedTotalPrice(), 3, 'COMMA') : ''}"></td> <!-- 출자 총액 -->
        <td class="text-end">100.00</td> <!-- 출자 비율 총합 -->

        <!-- 배분 원금, 배분 이익, 배분 총액 -->
        <td class="text-end" th:text="${fund.allocPrincipal != null and fund.allocPrincipal != 0 ? #numbers.formatInteger(fund.allocPrincipal, 3, 'COMMA') : ''}"></td>
        <td class="text-end" th:text="${fund.allocProfit != null and fund.allocProfit != 0 ? #numbers.formatInteger(fund.allocProfit, 3, 'COMMA') : ''}"></td>
        <td class="text-end" th:text="${fund.allocTotal != null and fund.allocTotal != 0 ? #numbers.formatInteger(fund.allocTotal, 3, 'COMMA') : ''}"></td>

        <!-- 배분 비율 (배분 총액 / 출자 총액 * 100) -->
        <td class="text-end" th:text="${fund.getCommittedTotalPrice() != null and fund.getCommittedTotalPrice() != 0 ? #numbers.formatDecimal(fund.allocTotal / fund.getCommittedTotalPrice() * 100, 1, 2, 'POINT') : ''}"></td>
        <th colspan="3"></th>
    </tr>
    </tfoot>
</table>

</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let totalPrice = 0;
        let totalRate = 0;

        document.querySelectorAll(".committedUnitPrice").forEach(td => {
            let value = parseInt(td.innerText.replace(/[^0-9]/g, "")) || 0;
            totalPrice += value;
        });

        document.querySelectorAll(".contributionRate").forEach(td => {
            let value = parseFloat(td.innerText.replace(/[^0-9.]/g, "")) || 0;
            totalRate += value;
        });

        document.getElementById("totalCommittedUnitPrice").innerText = totalPrice ? totalPrice.toLocaleString() : "";
        document.getElementById("totalContributionRate").innerText = totalRate ? totalRate.toFixed(2) + " %" : "";
    });
</script>