<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조합정보조회</title>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/datatables-custom.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/slimTable.css}">
    <script th:src="@{/js/common.js}"></script>
    <script defer th:src="@{/js/searchModal.js}"></script>

    <style></style>

    <script>
        function fetchFundInfo(fundId) {
            fetch(`/api/funds/info/${fundId}`)
                .then(response => response.json())
                .then(data => updateFundInfo(data))
                .catch(error => console.error("데이터 로드 실패:", error));
        }

        function updateFundInfo(data) {
            console.log("받아온 데이터:", data);

            // 데이터의 모든 요소를 개별적으로 출력
            Object.entries(data).forEach(([key, value]) => {
                console.log(`${key}:`, value);
            });
            document.getElementById("fundId").value = data.fundId || "";
            document.getElementById("liquidationStatus").value = data.liquidationStatus || "";
            document.getElementById("liquidationDate").value = data.liquidationDate || "";
            document.getElementById("fundName").value = data.fundName || "";
            document.getElementById("fundNameDetail").value = data.fundNameDetail || "";
            document.getElementById("establishmentDate").value = data.establishmentDate || "";
            document.getElementById("duration").value = data.duration || "";
            document.getElementById("durationStartDate").value = data.durationStartDate || "";
            document.getElementById("durationEndDate").value = data.durationEndDate || "";
            document.getElementById("investmentDuration").value = data.investmentDuration || "";
            document.getElementById("investmentStartDate").value = data.investmentStartDate || "";
            document.getElementById("investmentEndDate").value = data.investmentEndDate || "";
            document.getElementById("committedTotalPrice").value = Number(data.committedTotalPrice).toLocaleString();
            document.getElementById("unitPrice").value = Number(data.unitPrice).toLocaleString();
            document.getElementById("fundOrganizationType").value = data.fundOrganizationType || "";
            document.getElementById("paymentType").value = data.paymentType || "";
            document.getElementById("leadFundManager").value = data.leadFundManager || "";
            document.getElementById("coreIvtManager").value = data.coreIvtManager || "";
            document.getElementById("auditorName").value = data.auditorName || "";
            document.getElementById("auditorDate").value = data.auditorDate || "";
            document.getElementById("trusteeCorporation").value = data.trusteeCorporation || "";
            document.getElementById("administrationCorporation").value = data.administrationCorporation || "";
            document.getElementById("targetReturnRate").value = data.targetReturnRate;
            document.getElementById("performanceFeeRate").value = data.performanceFeeRate;
            document.getElementById("managementFeeInvestmentPeriod").value = data.managementFeeInvestmentPeriod || "";
            document.getElementById("managementFeeManagementPeriod").value = data.managementFeeManagementPeriod || "";
            // document.getElementById("agreementCriteria").value = data.agreementCriteria || "";
            document.getElementById("incentiveCondition").value = data.incentiveCondition || "";
            document.getElementById("priorLossGP").value = data.priorLossGP || "";
            document.getElementById("priorLossLP").value = data.priorLossLP || "";

            updateFundMembersTable(data.fundMems);
        }
        function updateFundMembersTable(fundMems) {
            const tableBody = document.getElementById("fundMembersTable");
            tableBody.innerHTML = "";

            fundMems.forEach(member => {
                // null 값이 아닌 경우에만 row 추가
                if (member.memberName || member.memberType || member.committedUnitPrice || member.contact || member.address || member.businessRegNo || member.residentRegNo) {
                    const formattedPrice = member.committedUnitPrice ? Number(member.committedUnitPrice).toLocaleString() : ""; // 천단위 콤마 추가

                    const row = `<tr>
                <td>${member.memberName || ""}</td>
                <td>${member.memberType || ""}</td>
                <td>${formattedPrice}</td>
                <td>${member.contact || ""}</td>
                <td colspan="2">${member.address || ""}</td>
                <td>${member.regNo || ""}</td>
            </tr>`;
                    tableBody.innerHTML += row;
                }
            });
        }


        function formatNumber(value) {
            if (!value) return "";
            return Number(value).toLocaleString(); // 천 단위 콤마 추가
        }

        document.addEventListener("DOMContentLoaded", function () {
            let fundId = document.getElementById("fundIdValue").value;
            if (fundId) {
                fetchFundInfo(fundId);
            }
        });

    </script>


    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            // ✅ fundId 값을 hidden input에서 가져오기
            let fundIdInput = document.getElementById("fundIdValue");
            let fundId = fundIdInput ? fundIdInput.value : null;

            console.log("✅ fundId:", fundId);

            if (fundId) {
                window.fundId = fundId; // ✅ 전역 변수에 저장
                fetchFundInfo(fundId); // ✅ 회사 정보 불러오기
            } else {
                console.warn("⚠️ fundId를 가져올 수 없습니다.");
            }
            // 입력 팝업 열기 함수
            // 팝업 열기 함수
            window.openPopup = function (type) {
                if (!window.fundId) {
                    alert("먼저 조합 정보를 조회한 후 입력하세요.");
                    return;
                }
                let url = `/fundAdd/${type}/${window.fundId}`;


                let width = 800;
                let height = 600;

                if (type === "audit") {
                    height = 300;
                } else if (type === "staff") {
                    height = 340;
                } else if (type === "fundFinancial") {
                    height = 750;
                } else if (type === "member") {
                    width = 1350;
                    height = 800;
                }

                window.open(url, "popupWindow", `width=${width},height=${height},scrollbars=yes`);

            };
            // 🔥 조회 팝업 열기 함수
            window.openViewPopup = function (type) {
                if (!window.fundId) {
                    alert("먼저 기업 정보를 조회한 후 확인하세요.");
                    return;
                }
                let url = `/fundShow/${type}/${window.fundId}`;
                let width = 800;
                let height = 600;
                // companyId에 따른 팝업 크기 조건 설정
                if (type === "auditsByFund") {
                    width = 600;
                    height = 400;
                } else if (type === "staffsByFund") {
                    height = 500;
                } else if (type === "financialsByFund") {
                    width = 1400;
                    height = 500;
                } else if (type === "dueDiligenceByFund") {
                    width = 900;
                    height = 500;
                } else if (type === "membersByFund") {
                    // width = 1350;
                    height = 800;
                } else if (type === "IASByfund") {
                    width = 1350;
                    height = 700;
                } else if (type === "dueDiligenceByFund") {
                    height = 500;
                } else if (type === "empChangeByFund") {
                    height = 500;
                }
                window.open(url, "popupWindow", `width=${width},height=${height},scrollbars=yes`);
            };
        });
    </script>

</head>
<body>

<div th:replace="fragments/navbar :: navbar"></div>
<div th:replace="fragments/searchModal :: searchModal"></div>


<div class="wrapper">

    <input type="hidden" id="fundIdValue" th:value="${fundId}" />

    <!-- 📌 좌측 사이드바 -->
    <nav class="sidebar">
        <a href="#" onclick="openPopup('audit')">🧑🏻‍💼 회계감사인 관리</a>
        <a href="#" onclick="openViewPopup('auditsByFund')">🧑🏻‍💼 회계감사인 이력조회</a>
        <a href="#" onclick="openPopup('staff')">💼 운용인력 관리</a>
        <a href="#" onclick="openViewPopup('staffsByFund')">💼 운용인력 이력조회</a>
        <a href="#" onclick="openPopup('fundFinancial')">🗂️ 재무제표 관리</a>
        <a href="#" onclick="openViewPopup('financialsByFund')">🗂️ 재무제표 이력조회</a>
        <a href="#" onclick="openPopup('member')">👤 조합원명부 관리</a>
        <a href="#" onclick="openViewPopup('membersByFund')">👤 조합원명부 조회</a>
        <a href="#" onclick="openViewPopup('IASByfund')">💰 투자자산총괄표 조회</a>
        <!--        <a href="#" onclick="openViewPopup('#')">🪪 투자조합평가결과 조회</a>-->
        <a href="#" onclick="openViewPopup('dueDiligenceByFund')">🔍 투자기업실사 조회</a>
        <a href="#" onclick="openViewPopup('empChangeByFund')">👥 고용인력 이력조회</a>
    </nav>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let fundId = document.getElementById("fundIdValue").value;
            console.log("✅ fundId:", fundId);
            if (fundId) {
                fetchFundInfo(fundId);
            }
        });
    </script>
    <!-- 📌 메인 콘텐츠 영역 -->
    <div class="content">
        <h2>조합 정보 조회</h2>
        <!-- 1. 회사 기본 정보 -->
        <table class="table table-bordered text-center">
            <thead>
            <tr><th colspan="8">투자조합 고유정보</th></tr>
            </thead>
            <tbody>
            <tr>
                <th>조합 고유번호</th>
                <td colspan="2"><input type="text" class="form-control" name="fundId" id="fundId" readonly></td>
                <th>청산여부</th>
                <td>
                    <select class="form-control" id="liquidationStatus" disabled>
                        <option value="">선택하세요</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </td>
                <th>청산일자</th>
                <td colspan="2"><input type="date" class="form-control" id="liquidationDate" readonly></td>
            </tr>
            <tr>
                <th>세부조합명</th>
                <td colspan="2"><input type="text" class="form-control" id="fundNameDetail" readonly></td>
                <th>조합명</th>
                <td><input type="text" class="form-control" id="fundName" readonly></td>
                <th>결성총액일</th>
                <td colspan="2"><input type="date" class="form-control" id="establishmentDate" readonly></td>
            </tr>
            <tr>
                <th>존속기간(년)</th>
                <td colspan="2"><input type="number" class="form-control" id="duration" readonly></td>
                <th>존속기간 시작일</th>
                <td><input type="date" class="form-control" id="durationStartDate" readonly></td>
                <th>존속기간 종료일</th>
                <td colspan="2"><input type="date" class="form-control" id="durationEndDate" readonly></td>
            </tr>
            <tr>
                <th>투자기간(년)</th>
                <td colspan="2"><input type="number" class="form-control" id="investmentDuration" readonly></td>
                <th>투자기간 시작일</th>
                <td><input type="date" class="form-control" id="investmentStartDate" readonly></td>
                <th>투자기간 종료일</th>
                <td colspan="2"><input type="date" class="form-control" id="investmentEndDate" readonly></td>
            </tr>
            <tr>
                <th>약정 총액</th>
                <td colspan="2"><input type="text" class="form-control" id="committedTotalPrice" readonly></td>
                <th>1좌당 금액</th>
                <td colspan="4"><input type="text" class="form-control" id="unitPrice" readonly></td>
            </tr>
            <tr>
                <th>투자기구 유형</th>
                <td colspan="2">
                    <select class="form-control" id="fundOrganizationType" disabled>
                        <option value="">선택하세요</option>
                        <option value="개인투자조합">개인투자조합</option>
                        <option value="벤처투자조합">벤처투자조합</option>
                    </select>
                </td>
                <th>납입방법</th>
                <td colspan="4">
                    <select class="form-control" id="paymentType" disabled>
                        <option value="">선택하세요</option>
                        <option value="수시납">수시납</option>
                        <option value="일시납">일시납</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>대표펀드매니저</th>
                <td colspan="2"><input type="text" class="form-control" id="leadFundManager" readonly></td>
                <th>핵심운용인력</th>
                <td colspan="4"><input type="text" class="form-control" id="coreIvtManager" readonly></td>
            </tr>
            <tr>
                <th>회계감사인명</th>
                <td colspan="2"><input type="text" class="form-control" id="auditorName" readonly></td>
                <th>회계감사인 변경일자</th>
                <td colspan="4"><input type="date" class="form-control" id="auditorDate" readonly></td>
            </tr>
            <tr>
                <th>수탁회사(은행)</th>
                <td colspan="2"><input type="text" class="form-control" id="trusteeCorporation" readonly></td>
                <th>사무수탁법인</th>
                <td colspan="4"><input type="text" class="form-control" id="administrationCorporation" readonly></td>
            </tr>

            <tr><th colspan="8">투자조합 보수조건</th></tr>
            <tr>
                <th>기준수익률(%)</th>
                <td colspan="2"><input type="number" step="0.01" class="form-control" id="targetReturnRate" readonly></td>
                <th>성과보수율(%)</th>
                <td colspan="4"><input type="number" step="0.01" class="form-control" id="performanceFeeRate" readonly></td>
            </tr>
            <tr>
                <th>투자기간 관리보수</th>
                <td colspan="7"><input type="text" step="0.01" class="form-control" id="managementFeeInvestmentPeriod" readonly></td>
            </tr>
            <tr>
                <th>운영기간 관리보수</th>
                <td colspan="7"><input type="text" step="0.01" class="form-control" id="managementFeeManagementPeriod" readonly></td>
            </tr>
            <tr>
                <th>인센티브 조건</th>
                <td colspan="7"><input type="text" class="form-control" id="incentiveCondition" readonly></td>
            </tr>
            <tr>
                <th>우선손실충당 GP</th>
                <td colspan="7"><input type="text" class="form-control" id="priorLossGP" readonly></td>
            </tr>
            <tr>
                <th>우선손실충당 LP</th>
                <td colspan="7"><input type="text" class="form-control" id="priorLossLP" readonly></td>
            </tr>
            <tr><th colspan="8">투자조합 의무투자조건 - 주목적/특수목적 투자조건</th></tr>
            <tr>
                <th>의무투자 1</th>
                <td colspan="2"><input type="text" class="form-control" id="mandatoryInvestment1" readonly></td>
                <th>의무투자 2</th>
                <td colspan="4"><input type="text" class="form-control" id="mandatoryInvestment2" readonly></td>
            </tr>
            <tr>
                <th>주목적투자 1</th>
                <td colspan="2"><input type="text" class="form-control" id="primaryInvestment1" readonly></td>
                <th>주목적투자 2</th>
                <td colspan="4"><input type="text" class="form-control" id="primaryInvestment2" readonly></td>
            </tr>
            <tr>
                <th>특수목적투자 1</th>
                <td colspan="2"><input type="text" class="form-control" id="specialPurposeInvestment1" readonly></td>
                <th>특수목적투자 2</th>
                <td colspan="4"><input type="text" class="form-control" id="specialPurposeInvestment2" readonly></td>
            </tr>
            <tr>
                <th>특수목적투자 3</th>
                <td colspan="2"><input type="text" class="form-control" id="specialPurposeInvestment3" readonly></td>
                <th>특수목적투자 기타</th>
                <td colspan="4"><input type="text" class="form-control" id="specialPurposeInvestment4" readonly></td>
            </tr>
            </tbody>

            <!-- 투자조합원 명부 -->
            <thead>
            <tr><th colspan="8">투자조합 조합원 명부</th></tr>
            <tr>
                <th>조합원</th>
                <th>조합원유형</th>
                <th>출자약정액</th>
                <th>연락처</th>
                <th colspan="2">주소</th>
                <th>사업자・주민등록번호</th>
<!--                <th>주민등록번호</th>-->
            </tr>
            </thead>
            <tbody id="fundMembersTable"></tbody>



        </table>


    </div>
</div>


</body>
</html>
