<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>후속 투자 정보 입력</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
        }
        th {
            background-color: #f2f2f2;
        }
        input {
            width: 100%;
            border: none;
            text-align: center;
        }
    </style>
  <script>
      function submitFirstForm() {
          let form = document.getElementById("firstForm");

          if (!form) {
              alert("폼을 찾을 수 없습니다.");
              return;
          }

          let formData = new FormData(form);

          fetch("/api/companies/createFollowup", {  // ✅ 절대 경로 사용
              method: "POST",
              body: formData
          })
              .then(response => {
                  if (!response.ok) {
                      throw new Error("저장 실패: " + response.status);
                  }
                  return response.json();
              })
              .then(data => {
                  alert("저장이 완료되었습니다!");
                  //document.getElementById("secondForm").style.display = "block";  // ✅ 2번 폼 표시
              })
              .catch(error => {
                  alert("저장 중 오류 발생: " + error.message);
                  //document.getElementById("secondForm").style.display = "block";  // ✅ 임시로 2번 폼 표시
              });
      }


    function submitSecondForm() {
        let form = document.getElementById("secondForm");

        if (!form) {
            alert("폼을 찾을 수 없습니다.");
            return;
        }

        // 폼 데이터를 JSON 형식으로 변환
        let formData = new FormData(form);
        let jsonData = {};

        formData.forEach((value, key) => {
            // 숫자로 변환할 값들 (주주 수 & 총 발행 주식 수)
            if (key.startsWith("shareholderCount") || key === "totalShareCount") {
                jsonData[key] = parseInt(value, 10) || 0; // 빈 값이면 0
            }
            // % 기호가 포함된 지분율 값 처리
            else if (key.startsWith("shareholderRate")) {
                jsonData[key] = parseFloat(value.replace("%", "").trim()) || 0; // % 제거 후 변환
            }
            // 나머지는 그대로 저장
            else {
                jsonData[key] = value;
            }
        });

        console.log("전송할 데이터:", jsonData); // 디버깅용
      fetch("/api/companies/createShareholder", {
          method: "POST",
          headers: {
              "Content-Type": "application/json"
          },
          body: JSON.stringify(jsonData)
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error("주주 정보 저장 실패");
                }
                return response.json();
              })
              .then(data => {
                alert("주주 정보가 저장되었습니다!");
              })
              .catch(error => {
                alert("저장 중 오류 발생: " + error.message);
              });
    }

    function updateEquityRate() {
      let totalShares = parseFloat(document.getElementById("totalShareCount").value) || 1; // 총 발행 주식 수
      let totalPercentage = 0;

      for (let i = 1; i <= 8; i++) {
        let shares = parseFloat(document.getElementById("shareholderCount" + i).value) || 0;
        let rateField = document.getElementById("shareholderRate" + i);
        let percentage = (shares / totalShares) * 100;
        rateField.value = percentage.toFixed(2) + "%";
        totalPercentage += percentage;
      }

      // 지분율 총합 업데이트
      document.getElementById("totalEquityRate").value = totalPercentage.toFixed(2) + "%";
    }

    function updateTotalShares() {
      let sum = 0;
      for (let i = 1; i <= 8; i++) {
        sum += parseFloat(document.getElementById("shareholderCount" + i).value) || 0;
      }
      document.getElementById("totalShareCount").value = sum;
      updateEquityRate();
    }
  </script>
</head>
<body class="container mt-4">

<form id="firstForm" th:action="@{/api/companies/followupInvestment}" method="post">

  <input type="hidden" name="companyId" th:value="${companyId}">
  <!--    <input type="hidden" name="followupEmployee" th:value="${session.loggedInUserName}">-->
  <h2 class="mb-4">후속 투자 정보 입력</h2>
  <div class="mb-3"><label class="form-label">투자 기관</label>
    <input type="text" class="form-control" name="followupCompanyName" placeholder="투자 기관 입력">
  </div>

  <div class="mb-3"><label class="form-label">투자 상품</label>
    <select class="form-control" name="followupProduct">
      <option value="">선택하세요</option>
      <option value="EQUITY,CS">보통주(CS)</option>
      <option value="RCPS">상환전환우선주(RCPS)</option>
      <option value="CPS">전환우선주(CPS)</option>
      <option value="CB">전환사채(CB)</option>
      <option value="BW">신주인수권부사채(BW)</option>
      <option value="EB">교환사채(EB)</option>
      <option value="CN">컨버터블노트(CN)</option>
      <option value="SAFE">세이프(SAFE)</option>
    </select>
  </div>

<div class="mb-3">
    <label class="form-label">투자 날짜</label>
    <input type="date" class="form-control" name="followupStartDate">
</div>

  <div class="mb-3"><label class="form-label">투자 단가 (단위: 원)</label>
    <input type="number" class="form-control" name="followupUnitPrice">
  </div>

  <div class="mb-3"><label class="form-label">주식 수량 (단위: 주)</label>
    <input type="number" class="form-control" name="followupShareCount">
  </div>

  <div class="mb-3"><label class="form-label">투자 금액 (단위: 원)</label>
    <input type="number" class="form-control" name="followupSumPrice">
  </div>

  <div class="mb-3"><label class="form-label">지분율 (단위: %)</label>
    <input type="number" class="form-control" name="followupEquityRate" required>
  </div>

  <div class="mt-4">
      <button type="button" class="btn btn-primary" onclick="submitFirstForm()">추가 생성</button>
  </div>
</form>
<hr>
<!--
<h4 class="mb-3">기존 주주구성</h4>
<table class="table table-bordered text-center">
    <tbody>
    <tr>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName1}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName2}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName3}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName4}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName5}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName6}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName7}" placeholder="주주명"></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderName8}" placeholder="주주명"></td>
        <td>발행총주식수</td>
    </tr>
    <tr>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount1}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount2}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount3}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount4}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount5}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount6}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount7}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.shareholderCount8}"></td>
        <td><input type="number" class="form-control" th:value="${readShareholder.totalShareCount}" readonly></td>
    </tr>
    <tr>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate1}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate2}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate3}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate4}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate5}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate6}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate7}" readonly></td>
        <td><input type="text" class="form-control" th:value="${readShareholder.shareholderRate8}" readonly></td>
        <td><input type="text" class="form-control" value="100%" readonly></td>
    </tr>
    </tbody>
</table>
-->
<!-- 주주변경 폼 -->
<table>
    <tr>
        <th>주주명 1</th>
        <th>주주명 2</th>
        <th>주주명 3</th>
        <th>주주명 4</th>
        <th>주주명 5</th>
        <th>주주명 6</th>
        <th>주주명 7</th>
        <th>주주명 8</th>
        <th>발행총주식수</th>
    </tr>
    <tr>
        <td><label for="shareholderName1"></label><input type="text" id="shareholderName1" th:value="${shrDTO.shareholderName1}"></td>
        <td><label for="shareholderName2"></label><input type="text" id="shareholderName2" th:value="${shrDTO.shareholderName2}"></td>
        <td><label for="shareholderName3"></label><input type="text" id="shareholderName3" th:value="${shrDTO.shareholderName3}"></td>
        <td><label for="shareholderName4"></label><input type="text" id="shareholderName4" th:value="${shrDTO.shareholderName4}"></td>
        <td><label for="shareholderName5"></label><input type="text" id="shareholderName5" th:value="${shrDTO.shareholderName5}"></td>
        <td><label for="shareholderName6"></label><input type="text" id="shareholderName6" th:value="${shrDTO.shareholderName6}"></td>
        <td><label for="shareholderName7"></label><input type="text" id="shareholderName7" th:value="${shrDTO.shareholderName7}"></td>
        <td><label for="shareholderName8"></label><input type="text" id="shareholderName8" th:value="${shrDTO.shareholderName8}"></td>
        <td rowspan="3"><label for="totalShareCount"></label><input type="number" id="totalShareCount" th:value="${shrDTO.totalShareCount}" readonly></td>
    </tr>
    <tr>
        <td><label for="shareholderCount1"></label><input type="number" id="shareholderCount1" th:value="${shrDTO.shareholderCount1}"></td>
        <td><label for="shareholderCount2"></label><input type="number" id="shareholderCount2" th:value="${shrDTO.shareholderCount2}"></td>
        <td><label for="shareholderCount3"></label><input type="number" id="shareholderCount3" th:value="${shrDTO.shareholderCount3}"></td>
        <td><label for="shareholderCount4"></label><input type="number" id="shareholderCount4" th:value="${shrDTO.shareholderCount4}"></td>
        <td><label for="shareholderCount5"></label><input type="number" id="shareholderCount5" th:value="${shrDTO.shareholderCount5}"></td>
        <td><label for="shareholderCount6"></label><input type="number" id="shareholderCount6" th:value="${shrDTO.shareholderCount6}"></td>
        <td><label for="shareholderCount7"></label><input type="number" id="shareholderCount7" th:value="${shrDTO.shareholderCount7}"></td>
        <td><label for="shareholderCount8"></label><input type="number" id="shareholderCount8" th:value="${shrDTO.shareholderCount8}"></td>
    </tr>
    <tr>
        <td><label for="shareholderRate1"></label><input type="text" id="shareholderRate1" th:value="|${shrDTO.shareholderRate1} %|"></td>
        <td><label for="shareholderRate2"></label><input type="text" id="shareholderRate2" th:value="|${shrDTO.shareholderRate2} %|"></td>
        <td><label for="shareholderRate3"></label><input type="text" id="shareholderRate3" th:value="|${shrDTO.shareholderRate3} %|"></td>
        <td><label for="shareholderRate4"></label><input type="text" id="shareholderRate4" th:value="|${shrDTO.shareholderRate4} %|"></td>
        <td><label for="shareholderRate5"></label><input type="text" id="shareholderRate5" th:value="|${shrDTO.shareholderRate5} %|"></td>
        <td><label for="shareholderRate6"></label><input type="text" id="shareholderRate6" th:value="|${shrDTO.shareholderRate6} %|"></td>
        <td><label for="shareholderRate7"></label><input type="text" id="shareholderRate7" th:value="|${shrDTO.shareholderRate7} %|"></td>
        <td><label for="shareholderRate8"></label><input type="text" id="shareholderRate8" th:value="|${shrDTO.shareholderRate8} %|"></td>
    </tr>
</table>

<br>
<button onclick="submitData()">저장</button>

<script>
    function submitData() {
        const data = {
            companyId: '[[${companyId}]]',
            shareholderName1: document.getElementById("shareholderName1").value,
            shareholderName2: document.getElementById("shareholderName2").value,
            shareholderName3: document.getElementById("shareholderName3").value,
            shareholderName4: document.getElementById("shareholderName4").value,
            shareholderName5: document.getElementById("shareholderName5").value,
            shareholderName6: document.getElementById("shareholderName6").value,
            shareholderName7: document.getElementById("shareholderName7").value,
            shareholderName8: document.getElementById("shareholderName8").value,

            shareholderCount1: Number(document.getElementById("shareholderCount1").value),
            shareholderCount2: Number(document.getElementById("shareholderCount2").value),
            shareholderCount3: Number(document.getElementById("shareholderCount3").value),
            shareholderCount4: Number(document.getElementById("shareholderCount4").value),
            shareholderCount5: Number(document.getElementById("shareholderCount5").value),
            shareholderCount6: Number(document.getElementById("shareholderCount6").value),
            shareholderCount7: Number(document.getElementById("shareholderCount7").value),
            shareholderCount8: Number(document.getElementById("shareholderCount8").value),

            shareholderRate1: parseFloat(document.getElementById("shareholderRate1").value),
            shareholderRate2: parseFloat(document.getElementById("shareholderRate2").value),
            shareholderRate3: parseFloat(document.getElementById("shareholderRate3").value),
            shareholderRate4: parseFloat(document.getElementById("shareholderRate4").value),
            shareholderRate5: parseFloat(document.getElementById("shareholderRate5").value),
            shareholderRate6: parseFloat(document.getElementById("shareholderRate6").value),
            shareholderRate7: parseFloat(document.getElementById("shareholderRate7").value),
            shareholderRate8: parseFloat(document.getElementById("shareholderRate8").value),

            totalShareCount: Number(document.getElementById("totalShareCount").value)
        };

        fetch("/api/companies/createShareholder", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                alert("데이터가 저장되었습니다.");
                location.reload();
            })
            .catch(error => console.error("Error:", error));
    }
</script>
</body>
</html>