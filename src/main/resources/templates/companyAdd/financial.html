<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¬ë¬´ ì •ë³´ ì…ë ¥</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/slimTable.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/popUpNavbar.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function formatNumberInput(input) {
                input.addEventListener("input", function () {
                    let value = this.value
                        .replace(/[^0-9.-]/g, "")  // ìˆ«ì, ë§ˆì´ë„ˆìŠ¤(-), ì†Œìˆ˜ì (.)ë§Œ í—ˆìš©
                        .replace(/(?!^)-/g, "")   // ë§¨ ì•ì´ ì•„ë‹Œ ê³³ì˜ '-' ì œê±°
                        .replace(/^(-?\d*)(\.\d*)?.*$/, "$1$2"); // ì˜¬ë°”ë¥¸ ì†Œìˆ˜ì  í‘œí˜„ ìœ ì§€

                    if (value !== "" && !isNaN(value)) {
                        let numValue = parseFloat(value).toLocaleString("en-US", {
                            minimumFractionDigits: value.includes(".") ? 1 : 0,
                            maximumFractionDigits: 10
                        });

                        this.value = value.endsWith(".") ? numValue + "." : numValue; // ì†Œìˆ˜ì  ìœ ì§€
                    }
                });

                input.addEventListener("blur", function () {
                    let value = this.value.replace(/,/g, "");
                    if (value !== "" && !isNaN(value)) {
                        this.value = parseFloat(value).toLocaleString("en-US", {
                            minimumFractionDigits: value.includes(".") ? 1 : 0,
                            maximumFractionDigits: 10
                        });
                    }
                });
            }

            // ì¬ë¬´ ì…ë ¥ í•„ë“œì— ì ìš© (ê¸ˆì•¡ ê´€ë ¨ í•„ë“œ)
            const financialFields = document.querySelectorAll(".financial-number");
            financialFields.forEach(formatNumberInput);

            // ğŸ”¥ í¼ ì œì¶œ ì‹œ ìˆ«ì í•„ë“œì˜ ì½¤ë§ˆ ì œê±° í›„ ì „ì†¡
            document.getElementById("financialForm").addEventListener("submit", function (event) {
                financialFields.forEach(field => {
                    field.value = field.value.replace(/,/g, ""); // ì½¤ë§ˆ ì œê±°
                });
            });
        });

        function submitFinancialForm(event) {
            event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë°©ì§€

            let formData = {
                companyId: document.getElementById("companyId")?.value.trim() || "",
                financialYear: document.getElementById("financialYear")?.value.trim() || "",
                financialHalf: document.getElementById("financialHalf")?.value.trim() || "",
                revenue: document.getElementById("revenue")?.value.trim() || "",
                operatingProfit: document.getElementById("operatingProfit")?.value.trim() || "",
                netIncome: document.getElementById("netIncome")?.value.trim() || "",
                totalAssets: document.getElementById("totalAssets")?.value.trim() || "",
                totalCapital: document.getElementById("totalCapital")?.value.trim() || "",
                capital: document.getElementById("capital")?.value.trim() || "",
                employeeCount: document.getElementById("employeeCount")?.value.trim() || "",
                totalDebt: document.getElementById("totalDebt")?.value.trim() || ""
            };
            console.log(formData);

            fetch("/api/companies/createFinancial", {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("ì €ì¥ ì‹¤íŒ¨");
                    }
                    return response.text();
                })
                .then(data => {
                    alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í™”ë©´ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                    window.close(); // íŒì—… í™”ë©´ ì¢…ë£Œ
                })
                .catch(error => {
                    alert("ì˜¤ë¥˜ë°œìƒ, ì…ë ¥ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. " + error.message);
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("financialForm").addEventListener("submit", submitFinancialForm);
        });
    </script>
</head>
<body class="container mt-4">

<div th:replace="fragments/popUpNavbar :: navbar"></div>
<h2 class="mb-4">ì¬ë¬´ ì •ë³´ ì…ë ¥</h2>

<form id="financialForm">
    <!-- íšŒì‚¬ ê³ ìœ ë²ˆí˜¸ ë° ì‚¬ìš©ì ì •ë³´ -->
    <input type="hidden" id="companyId" name="companyId" th:value="${companyId}" />
    <!--    <input type="hidden" id="createUser" name="createUser" th:value="${loggedInUser}" />-->
    <!--    <input type="hidden" id="updateUser" name="updateUser" th:value="${loggedInUser}" />-->
    <table class="table table-bordered text-center">
        <tbody>
        <tr>
            <th>íšŒê³„ì—°ë„</th>
            <td><input type="text" class="form-control" id="financialYear" placeholder=""></td>
            <th>ë°˜ê¸°</th>
            <td>
                <select class="form-control" id="financialHalf">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ìƒë°˜ê¸°">ìƒë°˜ê¸°</option>
                    <option value="í•˜ë°˜ê¸°">í•˜ë°˜ê¸°</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>ë§¤ì¶œì•¡(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="revenue" placeholder=""></td>
            <th>ì˜ì—…ì´ìµ(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="operatingProfit" placeholder=""></td>
        </tr>
        <tr>
            <th>ë‹¹ê¸°ìˆœì´ìµ(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="netIncome" placeholder=""></td>
            <th>ìì‚°ì´ê³„(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="totalAssets" placeholder=""></td>
        </tr>
        <tr>
            <th>ìë³¸ì´ê³„(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="totalCapital" placeholder=""></td>
            <th>ë¶€ì±„ì´ê³„(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="totalDebt" placeholder=""></td>
        </tr>
        <tr>
            <th>ìë³¸ê¸ˆ(ë°±ë§Œ ì›)</th>
            <td><input type="text" class="form-control financial-number" id="capital" placeholder=""></td>
            <th>ê³ ìš©ì¸ë ¥</th>
            <td><input type="text" class="form-control financial-number" id="employeeCount" placeholder=""></td>
        </tr>

        </tbody>
    </table>


    <!-- ì €ì¥ ë²„íŠ¼ -->
    <div class="button-container">
        <button type="submit" class="btn btn-primary">ì €ì¥</button>
    </div>
</form>

</body>
</html>
