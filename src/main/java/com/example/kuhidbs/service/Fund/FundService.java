package com.example.kuhidbs.service.Fund;

import com.example.kuhidbs.dto.Fund.*;
import com.example.kuhidbs.entity.Fund.Fund;
import com.example.kuhidbs.entity.Fund.FundAchievement;
import com.example.kuhidbs.repository.Fund.FundAchievementRepository;
import com.example.kuhidbs.repository.Fund.FundRepository;
import com.example.kuhidbs.repository.InvestmentAssetSummaryRepository;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class FundService {
    private static final Logger logger = LoggerFactory.getLogger(FundService.class);
    private final FundRepository fundRepository;
    private final FundAchievementRepository fundAchievementRepository;
    private final InvestmentAssetSummaryRepository investmentAssetSummaryRepository;
    // ÌéÄÎìú ÏÉùÏÑ±
    public Fund createFund(CFundDTO dto) {
        // 1Ô∏è‚É£ Fund ÏóîÌã∞Ìã∞ ÏÉùÏÑ±
        Fund fund = Fund.builder()
                .fundId(dto.getFundId()) // Ï°∞Ìï© Í≥†Ïú†Î≤àÌò∏
                .fundName(dto.getFundName()) // Ï°∞Ìï©Î™Ö
                .fundNameDetail(dto.getFundNameDetail()) // ÏÑ∏Î∂Ä Ï°∞Ìï©Î™Ö
                .establishmentDate(dto.getEstablishmentDate()) // ÏÑ§Î¶ΩÏùºÏûê (YYYY-MM-DD)
                .duration(dto.getDuration()) // Ï°¥ÏÜçÍ∏∞Í∞Ñ
                .durationStartDate(dto.getDurationStartDate()) // Ï°¥ÏÜçÍ∏∞Í∞Ñ ÏãúÏûëÏùº (YYYY-MM-DD)
                .durationEndDate(dto.getDurationEndDate()) // Ï°¥ÏÜçÍ∏∞Í∞Ñ Ï¢ÖÎ£åÏùº (YYYY-MM-DD)
                .investmentDuration(dto.getInvestmentDuration()) // Ìà¨ÏûêÍ∏∞Í∞Ñ
                .investmentStartDate(dto.getInvestmentStartDate()) // Ìà¨ÏûêÍ∏∞Í∞Ñ ÏãúÏûëÏùº (YYYY-MM-DD)
                .investmentEndDate(dto.getInvestmentEndDate()) // Ìà¨ÏûêÍ∏∞Í∞Ñ Ï¢ÖÎ£åÏùº (YYYY-MM-DD)
                .committedTotalPrice(dto.getCommittedTotalPrice()) // ÏïΩÏ†ï Ï¥ùÏï°
                .unitPrice(dto.getUnitPrice()) // 1Ï¢åÎãπ Í∏àÏï°
                .fundOrganizationType(dto.getFundOrganizationType()) // Ìà¨ÏûêÍ∏∞Íµ¨ Ïú†Ìòï
                .paymentType(dto.getPaymentType()) // ÎÇ©ÏûÖÎ∞©Î≤ï
                .leadFundManager(dto.getLeadFundManager()) // ÎåÄÌéÄ
                .coreIvtManager(dto.getCoreIvtManager()) // ÌïµÏö¥
                .trusteeCorporation(dto.getTrusteeCorporation()) // ÏóÖÎ¨¥ÏàòÌÉÅÎ≤ïÏù∏
                .administrationCorporation(dto.getAdministrationCorporation()) // ÏÇ¨Î¨¥ÏàòÌÉÅÎ≤ïÏù∏
                .targetReturnRate(dto.getTargetReturnRate()) // Í∏∞Ï§Ä ÏàòÏùµÎ•†
                .performanceFeeRate(dto.getPerformanceFeeRate()) // ÏÑ±Í≥º Î≥¥ÏàòÏú®
                .managementFeeInvestmentPeriod(dto.getManagementFeeInvestmentPeriod()) // Í¥ÄÎ¶¨Î≥¥Ïàò (Ìà¨ÏûêÍ∏∞Í∞Ñ)
                .managementFeeManagementPeriod(dto.getManagementFeeManagementPeriod()) // Í¥ÄÎ¶¨Î≥¥Ïàò (Ïö¥ÏòÅÍ∏∞Í∞Ñ)
                .agreementCriteria(dto.getAgreementCriteria()) // ÏïΩÏ†ïÍ∏∞Ï§ÄÏó¨Î∂Ä
                .incentiveCondition(dto.getIncentiveCondition()) // Ïù∏ÏÑºÌã∞Î∏å Ï°∞Í±¥
                .priorLossGP(dto.getPriorLossGP()) // Ïö∞ÏÑ†ÏÜêÏã§Ï∂©Îãπ GP
                .priorLossLP(dto.getPriorLossLP()) // Ïö∞ÏÑ†ÏÜêÏã§Ï∂©Îãπ LP
                .liquidationStatus(dto.getLiquidationStatus()) // Ï≤≠ÏÇ∞ Ïó¨Î∂Ä
                .liquidationDate(dto.getLiquidationDate()) // Ï≤≠ÏÇ∞ÏùºÏûê (YYYY-MM-DD)
                .mandatoryPurpose(dto.getMandatoryPurpose()) //ÏùòÎ¨¥Ìà¨Ïûê
                .mainInvest1Purpose(dto.getMainInvest1Purpose()) //Ï£ºÎ™©Ï†Å1
                .mainInvest2Purpose(dto.getMainInvest2Purpose()) //Ï£ºÎ™©Ï†Å2
                .mainInvest3Purpose(dto.getMainInvest3Purpose()) //Ï£ºÎ™©Ï†Å3
                .specialInvest1Purpose(dto.getSpecialInvest1Purpose()) //ÌäπÏàòÎ™©Ï†Å1
                .specialInvest2Purpose(dto.getSpecialInvest2Purpose()) //ÌäπÏàòÎ™©Ï†Å2
                .specialInvest3Purpose(dto.getSpecialInvest3Purpose()) //ÌäπÏàòÎ™©Ï†Å3
                .build();

        Fund savedFund = fundRepository.save(fund);
        logger.info("[INFO] ÌéÄÎìú ÏÉùÏÑ± ÏôÑÎ£å - ÌéÄÎìú ID: {}", savedFund.getFundId());

        // 2Ô∏è‚É£ FundAchievement ÏÉùÏÑ± (Î≥ÑÎèÑ Ìï®Ïàò Ìò∏Ï∂ú)
        createFundAchievement(savedFund, dto);

        return savedFund;
    }

    /**
     * ÌéÄÎìú Ï†ïÎ≥¥ ÏàòÏ†ï
     */
    @Transactional
    public UFundDTO updateFundInfo(UFundDTO updatedFundInfo) {
        Fund fund = fundRepository.findById(updatedFundInfo.getFundId())
                .orElseThrow(() -> new IllegalArgumentException("Ìï¥Îãπ ÌéÄÎìúÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§: " + updatedFundInfo.getFundId()));

        // Í∏∞Ï°¥ ÌéÄÎìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        fund.setLiquidationStatus(updatedFundInfo.getLiquidationStatus());
        fund.setLiquidationDate(updatedFundInfo.getLiquidationDate());
        fund.setFundName(updatedFundInfo.getFundName());
        fund.setFundNameDetail(updatedFundInfo.getFundNameDetail());
        fund.setEstablishmentDate(updatedFundInfo.getEstablishmentDate());
        fund.setDuration(updatedFundInfo.getDuration());
        fund.setDurationStartDate(updatedFundInfo.getDurationStartDate());
        fund.setDurationEndDate(updatedFundInfo.getDurationEndDate());
        fund.setInvestmentDuration(updatedFundInfo.getInvestmentDuration());
        fund.setInvestmentStartDate(updatedFundInfo.getInvestmentStartDate());
        fund.setInvestmentEndDate(updatedFundInfo.getInvestmentEndDate());
        fund.setCommittedTotalPrice(updatedFundInfo.getCommittedTotalPrice());
        fund.setUnitPrice(updatedFundInfo.getUnitPrice());
        fund.setFundOrganizationType(updatedFundInfo.getFundOrganizationType());
        fund.setPaymentType(updatedFundInfo.getPaymentType());
        fund.setLeadFundManager(updatedFundInfo.getLeadFundManager());
        fund.setCoreIvtManager(updatedFundInfo.getCoreIvtManager());
        fund.setTrusteeCorporation(updatedFundInfo.getTrusteeCorporation());
        fund.setAdministrationCorporation(updatedFundInfo.getAdministrationCorporation());
        fund.setTargetReturnRate(updatedFundInfo.getTargetReturnRate());
        fund.setPerformanceFeeRate(updatedFundInfo.getPerformanceFeeRate());
        fund.setManagementFeeInvestmentPeriod(updatedFundInfo.getManagementFeeInvestmentPeriod());
        fund.setManagementFeeManagementPeriod(updatedFundInfo.getManagementFeeManagementPeriod());
        fund.setIncentiveCondition(updatedFundInfo.getIncentiveCondition());
        fund.setPriorLossGP(updatedFundInfo.getPriorLossGP());
        fund.setPriorLossLP(updatedFundInfo.getPriorLossLP());
        fund.setMandatoryPurpose(updatedFundInfo.getMandatoryPurpose());
        fund.setMainInvest1Purpose(updatedFundInfo.getMainInvest1Purpose());
        fund.setMainInvest2Purpose(updatedFundInfo.getMainInvest2Purpose());
        fund.setMainInvest3Purpose(updatedFundInfo.getMainInvest3Purpose());
        fund.setSpecialInvest1Purpose(updatedFundInfo.getSpecialInvest1Purpose());
        fund.setSpecialInvest2Purpose(updatedFundInfo.getSpecialInvest2Purpose());
        fund.setSpecialInvest3Purpose(updatedFundInfo.getSpecialInvest3Purpose());

        fundRepository.save(fund);
        logger.info("[UPDATE] ÌéÄÎìú Ï†ïÎ≥¥ ÏàòÏ†ï ÏôÑÎ£å - fundId: {}", updatedFundInfo.getFundId());

        return mapToDTO(fund);
    }

    /**
     * Entity ‚Üí DTO Î≥ÄÌôò
     */
    private UFundDTO mapToDTO(Fund fund) {
        return UFundDTO.builder()
                .fundId(fund.getFundId())
                .liquidationStatus(fund.getLiquidationStatus())
                .liquidationDate(fund.getLiquidationDate())
                .fundName(fund.getFundName())
                .fundNameDetail(fund.getFundNameDetail())
                .establishmentDate(fund.getEstablishmentDate())
                .duration(fund.getDuration())
                .durationStartDate(fund.getDurationStartDate())
                .durationEndDate(fund.getDurationEndDate())
                .investmentDuration(fund.getInvestmentDuration())
                .investmentStartDate(fund.getInvestmentStartDate())
                .investmentEndDate(fund.getInvestmentEndDate())
                .committedTotalPrice(fund.getCommittedTotalPrice())
                .unitPrice(fund.getUnitPrice())
                .fundOrganizationType(fund.getFundOrganizationType())
                .paymentType(fund.getPaymentType())
                .leadFundManager(fund.getLeadFundManager())
                .coreIvtManager(fund.getCoreIvtManager())
                .trusteeCorporation(fund.getTrusteeCorporation())
                .administrationCorporation(fund.getAdministrationCorporation())
                .targetReturnRate(fund.getTargetReturnRate())
                .performanceFeeRate(fund.getPerformanceFeeRate())
                .managementFeeInvestmentPeriod(fund.getManagementFeeInvestmentPeriod())
                .managementFeeManagementPeriod(fund.getManagementFeeManagementPeriod())
                .incentiveCondition(fund.getIncentiveCondition())
                .priorLossGP(fund.getPriorLossGP())
                .priorLossLP(fund.getPriorLossLP())
                .mandatoryPurpose(fund.getMandatoryPurpose())
                .mainInvest1Purpose(fund.getMainInvest1Purpose())
                .mainInvest2Purpose(fund.getMainInvest2Purpose())
                .mainInvest3Purpose(fund.getMainInvest3Purpose())
                .specialInvest1Purpose(fund.getSpecialInvest1Purpose())
                .specialInvest2Purpose(fund.getSpecialInvest2Purpose())
                .specialInvest3Purpose(fund.getSpecialInvest3Purpose())
                .build();
    }


    private void createFundAchievement(Fund fund, CFundDTO dto) {
        FundAchievement fundAchievement = FundAchievement.builder()
                .fund(fund) // Ïô∏ÎûòÌÇ§(Fund) Ïó∞Í≤∞

                // üî• ÏùòÎ¨¥ Ìà¨Ïûê
                .mandatoryAmount(0L)
                .mandatoryCriteria(dto.getMandatoryCriteria())
                .mandatoryCriteriaRatio(dto.getMandatoryCriteriaRatio())
                .mandatoryTargetAmount(determineTotal(fund, dto.getMandatoryCriteria()))

                // üî• Ï£ºÎ™©Ï†Å Ìà¨Ïûê 1
                .mainInvest1Amount(0L)
                .mainInvest1Criteria(dto.getMainInvest1Criteria())
                .mainInvest1CriteriaRatio(dto.getMainInvest1CriteriaRatio())
                .mainInvest1TargetAmount(determineTotal(fund, dto.getMainInvest1Criteria()))

                // üî• Ï£ºÎ™©Ï†Å Ìà¨Ïûê 2
                .mainInvest2Amount(0L)
                .mainInvest2Criteria(dto.getMainInvest2Criteria())
                .mainInvest2CriteriaRatio(dto.getMainInvest2CriteriaRatio())
                .mainInvest2TargetAmount(determineTotal(fund, dto.getMainInvest2Criteria()))

                // üî• Ï£ºÎ™©Ï†Å Ìà¨Ïûê 3
                .mainInvest3Amount(0L)
                .mainInvest3Criteria(dto.getMainInvest3Criteria())
                .mainInvest3CriteriaRatio(dto.getMainInvest3CriteriaRatio())
                .mainInvest3TargetAmount(determineTotal(fund, dto.getMainInvest3Criteria()))

                // üî• ÌäπÏàòÎ™©Ï†Å Ìà¨Ïûê 1
                .specialInvest1Amount(0L)
                .specialInvest1Criteria(dto.getSpecialInvest1Criteria())
                .specialInvest1CriteriaRatio(dto.getSpecialInvest1CriteriaRatio())
                .specialInvest1TargetAmount(determineTotal(fund, dto.getSpecialInvest1Criteria()))

                // üî• ÌäπÏàòÎ™©Ï†Å Ìà¨Ïûê 2
                .specialInvest2Amount(0L)
                .specialInvest2Criteria(dto.getSpecialInvest2Criteria())
                .specialInvest2CriteriaRatio(dto.getSpecialInvest2CriteriaRatio())
                .specialInvest2TargetAmount(determineTotal(fund, dto.getSpecialInvest2Criteria()))

                // üî• ÌäπÏàòÎ™©Ï†Å Ìà¨Ïûê 3
                .specialInvest3Amount(0L)
                .specialInvest3Criteria(dto.getSpecialInvest3Criteria())
                .specialInvest3CriteriaRatio(dto.getSpecialInvest3CriteriaRatio())
                .specialInvest3TargetAmount(determineTotal(fund, dto.getSpecialInvest3Criteria()))

                .build();

        fundAchievementRepository.save(fundAchievement);
        logger.info("[INFO] FundAchievement Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å - ÌéÄÎìú ID: {}", fund.getFundId());
    }

    private Long determineTotal(Fund fund, String criteria) {
        if ("Ï∂úÏûêÏïΩÏ†ïÏï°".equals(criteria)) {
            return fund.getCommittedTotalPrice() != null ? fund.getCommittedTotalPrice() : 0L;
        } else if ("Ìà¨Ïûê ÏûîÏï°".equals(criteria)) {
            return (long) (fund.getCommittedTotalPrice()*0.8);
        }
        return 0L; // Í∏∞Î≥∏Í∞í
    }


    public List<RFundNameDTO> getAllFundIdAndName() {
        List<Object[]> results = fundRepository.findAllFundIdAndName();

        return results.stream()
                .map(row -> new RFundNameDTO((String) row[0], (String) row[1]))
                .collect(Collectors.toList());
    }

    public RFundDTO getFundById(String fundId) {
        Fund fund = fundRepository.findById(fundId)
                .orElseThrow(() -> new RuntimeException("Fund not found with ID: " + fundId));

        return RFundDTO.builder()
                .fundId(fund.getFundId())
                .fundName(fund.getFundName())
                .fundNameDetail(fund.getFundNameDetail())
                .establishmentDate(fund.getEstablishmentDate())
                .duration(fund.getDuration())
                .durationStartDate(fund.getDurationStartDate())
                .durationEndDate(fund.getDurationEndDate())
                .investmentDuration(fund.getInvestmentDuration())
                .investmentStartDate(fund.getInvestmentStartDate())
                .investmentEndDate(fund.getInvestmentEndDate())
                .committedTotalPrice(fund.getCommittedTotalPrice())
                .unitPrice(fund.getUnitPrice())
                .fundOrganizationType(fund.getFundOrganizationType())
                .paymentType(fund.getPaymentType())
                .leadFundManager(fund.getLeadFundManager())
                .coreIvtManager(fund.getCoreIvtManager())
                .trusteeCorporation(fund.getTrusteeCorporation())
                .administrationCorporation(fund.getAdministrationCorporation())
                .targetReturnRate(fund.getTargetReturnRate())
                .performanceFeeRate(fund.getPerformanceFeeRate())
                .managementFeeInvestmentPeriod(fund.getManagementFeeInvestmentPeriod())
                .managementFeeManagementPeriod(fund.getManagementFeeManagementPeriod())
                .incentiveCondition(fund.getIncentiveCondition())
                .priorLossGP(fund.getPriorLossGP())
                .priorLossLP(fund.getPriorLossLP())
                .liquidationStatus(fund.getLiquidationStatus())
                .liquidationDate(fund.getLiquidationDate())
                .mandatoryPurpose(fund.getMandatoryPurpose())
                .mainInvest1Purpose(fund.getMainInvest1Purpose())
                .mainInvest2Purpose(fund.getMainInvest2Purpose())
                .mainInvest3Purpose(fund.getMainInvest3Purpose())
                .specialInvest1Purpose(fund.getSpecialInvest1Purpose())
                .specialInvest2Purpose(fund.getSpecialInvest2Purpose())
                .specialInvest3Purpose(fund.getSpecialInvest3Purpose())
                .build();
    }
}

